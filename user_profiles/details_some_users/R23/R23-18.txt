Author manuscript, published in "Computer Graphics Forum (Proceedings of the Eurographics Symposium on Rendering 2008) 27, 4
(2008) 1285--1292"

8
0
0
2

 
c
e
D
8

 

 
-
 

i

 

1
n
o
s
r
e
v
 
,

5
8
2
5
4
3
0
0
-
a
i
r
n

i

EUROGRAPHICS2008/SteveMarschnerandMichaelWimmer(GuestEditors)Volume27(2008),Number4SampleBasedVisibilityforSoftShadowsusingAlias-freeShadowMapsErikSintorn1ElmarEisemann2UlfAssarsson11ChalmersUniversityofTechnology,Sweden2ARTIS-INRIA/GrenobleUniversity,FranceAbstractThispaperintroducesanaccuratereal-timesoftshadowalgorithmthatusessamplebasedvisibility.Initially,wepresentaGPU-basedalias-freehardshadowmapalgorithmthattypicallyrequiresonlyasinglerenderpassfromthelight,incontrasttousingdepthpeelingandonepassperlayer.Forclosedobjects,wealsosuppresstheneedforabias.Themethodisextendedtosoftshadowsamplingforanarbitrarilyshapedarea-/volumetriclightsourceusing128-1024lightsamplesperscreenpixel.Thealias-freeshadowmapguaranteesthatthevisibilityisaccuratelysampledperscreen-spacepixel,evenforarbitrarilyshaped(e.g.non-planar)surfacesorsolidobjects.Anothercontributionisasmoothcoherentshadingmodeltoavoidcommonlightleakagenearshadowbordersduetonormalinterpolation.CategoriesandSubjectDescriptors(accordingtoACMCCS):I.3.7[ComputerGraphics]:Three-DimensionalGraphicsandRealismShadowing1.IntroductionShadowsarenotonlyimportantforrealism,butalsotopro-videvisualcuesindicatingtherelativelocationsofobjects.Hardshadowsappearonlyunderdirectionallightorpointlightsources,whicharerareinnature.Therefore,theirlookseemsoftenartiﬁcialwhereassoftshadowsaretypicallymorerealisticandeye-pleasing.Thispaperpresentsamethodforinteractivesoftshadowren-deringfromarbitraryarea-orvolumetriclightsources.Con-trarytomostreal-timealgorithms,visibilityiscorrectlysam-pled,whichisdefactostandardforhighqualitysoftshadowsandourmethodcouldreplaceraytracedsolutions.Inmanycasesapproximatesolutionsfailtocon-vince[HLHS03].Aphysicallyplausiblecomputationfortheirradianceatapointpis:ZSL(p,y)v(p,y)cos(p−y,ny)cos(y−p,np)π||p−y||2dy(1)whereSisthesource,Listheincomingirradianceatp,visthebinaryvisibilityfunction,andnxthenormalatx.Ourap-proachcoulddirectlysamplethisequation,buttokeepthecomputationsdown,weusethecommonapproximationtoseparatelightingandvisibility.Theresultingintegralofvis-ibilityisstillchallengingtoapproximate.Thedifferenceofthisfactoredsolutionissubtlewhenreceiversareatacertaindistancefromthesource.OurﬁrstcontributionisaGPU-basedaliasfreeshadowmapimplementation.Incontrasttoprevioussolutions,wetyp-icallyrequireonlyonerender-passfromthelightposition.Forclosed(two-manifold)shadowcasters,itisalsomorerobustanddoesnotrequireanydepthbias.Thesecondandmaincontributionofourpaperisanefﬁcientsoftshadowalgorithm.Arbitraryvolumetricandtexturedlightsourcescanbehandled.Othercontributionsareanefﬁcientsamplelistrepresentation(Section3.1),asmoothcoherentshadingmodel(seeSection4.3),temporaljittering(Section7),andanefﬁcientpenumbraedetermination4.1.2.PreviousWorkAnexhaustivepresentationofpreviousworkisoutofthescopeofthisarticle,forthis,wereferthereadertothesur-veysbyHasenfratzetal.[HLHS03]andWooetal.[WPF90].ShadowMaps[Wil78]andShadowVolumes[Cro77]arethetwomostcommonalgorithmstocreatehardshadowsonarbitraryreceivers.Whileshadowvolumesareﬁll-ratedemanding,shadowmapssufferfromaliasingandrequirecarefuladjustmentofascenedependentdepthbias.ThissubmittedtoEUROGRAPHICS2008.8
0
0
2

 
c
e
D
8

 

 
-
 

i

 

1
n
o
s
r
e
v
 
,

5
8
2
5
4
3
0
0
-
a
i
r
n

i

2ErikSintorn&ElmarEisemann&UlfAssarsson/SampleBasedVisibilityforSoftShadowsbecomesnecessaryduetothelimiteddepthprecisionandadifferentdiscretizationwhenrasterizingfromtheeyeandthelight.Numeroussolutionshavebeenproposed,includingbetteradaptionoftheshadowmap[MT04,WSP04,LSO07],antialiasing[AMB∗07,PCdON04],orsuggestionstolowerthebias-concerns[HN85,WE03,Woo92].Alias-freeshadowmapsexistbasedoneithersoftwarerendering[AL04],newhardwarefeatures(stillnotavailable)[JLBM05],ordepthpeeling,requiringonerenderpassperdepthlayer[Arv07].HeckbertandHerf[HH97]combinehardshadowsonaplanetocreateshadowtextures.SoftShadowVolumes[AAM03]isinspiredfromtheshadowvolumealgorithm,butusesawedgepersilhouetteedge,asseenfromthelightsourcecenter,toaddacorrespondingpartofpenumbra.For-estetal.[FBP06]introducedamethodtoimprovetheusu-allyoverestimatedshadows,withavisibilitybufferpersil-houettetoachievemoreaccurateoccluderfusion.Laineetal.[LAA∗05]usedthesoftshadowvolumestoproducecor-rectlysamplebasedsoftshadowsforofﬂinerendering.Layeredattenuationmapscomputeanapproximateshadowbycombiningseveralshadowmaps[ARHM00].Image-basedraytracingtracesshadowraysthroughasetofdepthimagesproducedfromadiscretesetofsamplepointsoverthelightsource[ARHM00]ormultilayerdepthimagesin-cludingtransparencies[XTP07].Asingledepthmapisinsufﬁcienttogenerallyrepresentanoccluderevenforanon-pinholecamera(seeingaroundob-jects)likeMoandWyman’s[MW07],butcanleadtoplau-siblesoftshadowsasin[AHL∗06].Here,eachdepthsampleisdownprojectedonaplane,whereitscorrespondingoc-clusionisaccumulated.Guennebaudetal.[GBP06]takeaverysimilarapproach.Insteadofthedownprojection,oc-cludingpixelsaresearchedinthedepthmap,whichallowsself-occlusion.In[GBP07],theyimprovesearchandqualitybytracingoccludercontours.Balaetal.[BWG03]alsocom-binesparsesamplinganddiscontinuityeventstoachievein-teractiveperformance.Schwarzetal.[SS07]applybitarith-metictocombinesamplescorrectly,butneeddepthpeelingforaccurateshadows(seeFigure1).Kautzetal.[KLA04]One layerCompletegeometryFigure1:Left:Onedepthlayer&accurateshading.Thiscaseneedsfourandhasanalignedface.Right:OursolutionhaveaCPUdeterminationofilluminationusingbitarith-metic.EachtriangleofanLODmodelistestedagainsteachvertex.Afastapproximationispresentedin[ED06],whereseveralsceneslicesarecombinedusingaﬁlteringprocess.OuralgorithmismostcloselyrelatedtotheworkbyLaineetal.[LAA∗05]andEisemannandDécoret[ED07].Bothcom-puteaccuratelysampledvisibility.SoftShadowVolumesarecombinedwithraytracingin[LAA∗05].ThelatterisGPU-based,targetsreal-timepurposes,andusesanoverestima-tionofthepenumbra,theinﬂuenceregionfromtrianglestoprojecttheocclusionontoaplanar/heightﬁeldreceiver.Werefertothispaperforcompellingargumentswhyclassicap-proximationsoftengiveinsufﬁcientresult.3.AliasFreeShadowMapsforHardShadowsOverview-Initially,thesceneisrenderedfromtheeyeintoaviewtexturetoﬁndpoints(view-samples)forwhichshadowcomputationisneeded.Theseareforemostthevis-iblepointsfromtheeye.Samplesonback-facinggeometryw.r.t.thelightsourcecanalsobeexcludedsincetheyselfocclude(seeFigure2).Theview-samplesarethenprojectedandstoredintheshadowmap(SM).Visible & light backfacingVisible & light frontfacingInvisible & light backfacing Invisible & light frontfacingFigure2:Onlyvisibleandlightfront-facingview-samples(non-dashedblue)arestoredintheshadowmap.Theworldspacecoordinateandshadingstatusofeachsampleismain-tainedinalocallistattheshadowmappixel.Forclosedob-jects,onlylightback-facingtriangles(reddashedandnon-dashed)areusedasshadowcasters.Severaloftheview-samplescanfallinthesamepixel(seeFigure3-left),whichisthesourceofaliasinginstandardshadowmapping.Toavoidcollisions,westoretheminlist’sforeachSMpixel(Section3.1).Next,wetestwhethereachview-sampleislitorinshadow.Forthis,werenderthescenefromthelightsourceasfol-lows.Foreachtrianglet,afragmentshaderwillbeexecutedontheSMpixelsthatarepartiallyintersectedbyt’spro-jection.Weachievethisbyusingconservativerasterization(Section3.2).Foreachcoveredpixel,afragmentshadertra-versesthelistofview-samplesstoredatthislocationanddetermineswhetherthidestheview-samplefromthepointlight.Alltrianglesaretreatedseparately.Aftereachpass,theshadowinformation(lit/unlit)iscombinedwiththeresultforthepreviouslytestedgeometry(Section3.3).Oncealltrianglesareprocessed,theshadowsareappliedbyrenderingascreencoveringquadintheobserver’sview,andeachview-samplerecoversitscorrespondingshadowvalue.3.1.ConstructingandstoringtheshadowmaplistsFillingtheshadowmaplistswiththeview-samplesusesCUDA’sscatteringcapabilities.Theprocessismemorycom-pactandfasterthanstencilrouting[MB07].submittedtoEUROGRAPHICS2008.8
0
0
2

 
c
e
D
8

 

 
-
 

i

 

1
n
o
s
r
e
v
 
,

5
8
2
5
4
3
0
0
-
a
i
r
n

i

ErikSintorn&ElmarEisemann&UlfAssarsson/SampleBasedVisibilityforSoftShadows32302230List 1List 2List nFigure3:MemorylayoutoftheSMLists:view-samplespro-jectedintotheSM(left).Anoffsetandlengthperpixelallowtoaccessthesequentiallystoredlists(right).OurgoalistostoreineachpixeloftheSMalistlengthsandalistoffset.Thelistoffsetpointsintoaglobalarray,IA(seeFigure3),fromwhereallconsecutiveselementscorrespondtotheentriesofthelocallist.Withthisinformation,onecaniterateoverthelistelementsofeachSMpixelbyread-ingsuccessiveelementsinIA.Further,eachview-samplehasanoffsetintoIA.Itisstoredintheview-textureandallowstolookupavalue,associatedtoaview-sample.Inthecon-textofourshadowcomputation,eachentryofIAholdstheview-sample’sstatusinformation(lit/shadowed)aswellasitsworldposition.Construction-Toobtainthisstructure,weintializethelo-callists’lengthsintheSMtozero.Then,eachview-sample,pcam,isprojectedintotheSM,toapositionpSM.Thecur-rentlocallistsizesatpSMisreadandincrementedinstan-taneouslyusingtheatomicInc()instructioninCUDA.Thereadvalueisstoredatpcam’spositionintheviewtexture.Thisprocessassociatesauniqueindexitoeachview-samplethatcanbeusedasanoffsetintothelocallistitprojectsin.Atthesametime,ontheSMside,thiscounterultimatelyindicatesthenumberofelementsinthepixel’slocallist.ToconcatenatethelocallistsintheglobalarrayIA,eachoneneedsaparticularoffset.Forthis,arunningsumscan[HSO07]isevaluatedonthelistlengthmap.Thispro-cessinterpretsthe2Dtextureasa1Darray(linebyline)andstoresineachpixelthesumofallproceedingvalues.TheseareexactlytheoffsetsthatrepresentthestartofeachlistintheglobalarrayIA.TodirectlyaccessthedatainIAforaview-sample,weﬁnditsoffsetbyaddingthelistoffsetofthelistatpPMandtheview-samplesindexi.Thisﬁnaloffsetwillnotchangeuntiltheendoftheframeandwestoreitintheview-texture.Storage-Inpractice,insteadofhavingonearrayIAwithheterogenousdata(worldpositionandlit/shadowedstate)westoretheminseparatearraysusingthesameoffsetswederivedforIA.Thisallowsustopacktheshadowdatadenselyinsinglebits.Thisisbeneﬁcialbecauseeventhoughtheworldpositionremainsthesamethroughoutoneframe,theshadowstatewillbeupdatedforeachprocessedtriangleanditbecomespossibletousethecard’sbitwiseblendingoperationforthis.Nowadays,eightrendertargetsand32-bitchannelsallowustoupdate1024view-sampleshadowstatevaluesperlistandrenderpass.Ifmoreview-samplesareina pixelsview-samples stored in SM pixel’s list(i)(ii)(iii)duplicateda)b)c)Light’s viewFigure4:a)Withoutconservativerasterization,onlypixelswhosecenterisinsidethetrianglearerasterized.Sincesam-plepointscanlieanywhereinthepixel,conservativeraster-izationisrequired.b)Conservativerasterizationisdoneinthegeometryshader,bycomputingtheconvexhullofthetri-angle’svertexextensiontoapixel-sizedquad[HAMO05].c)Threecasescanoccuratcornersoftheconvexhull.Perfor-manceisimprovedsigniﬁcantlyiftheareaisapproximatedwithonlytwoverticesateachcorner.Forcaseiii)edgesareextendedbythewidthofapixel.list,blocksof1024samplesaretreated,andmulti-passren-deringisuseduntilallview-sampleshavebeenprocessed.However,inpractice,even128samplesproveenoughinmostcases.3.2.ConservativerasterizationHavinglistsofview-samplesineachpixeloftheSM,wenextrasterizethescene’strianglesonebyoneintotheSM.Foreachpixelintersectedbyatrianglet,thelocallististraversedandeachview-sampleistestedforocclusionbytwithrespecttothepointlightsource.Therasterizationneedstobeconservative(Figure4).Otherwise,ifthecen-terofthelistpixelisnotcovered,nofragmentwouldbeproducedandthusthecomputationwillnotbeappliedtothelist’selements(whichinturn,couldlieinthepartiallycov-eredregion).WeuseaversionofHasselgrenandAkenine-Möllers’salgorithm[HAMO05]executedonthegeometryshader,butwealwaysoutputaﬁxednumberof6vertices(4triangles)insteadofupto9vertices(7triangles)sincethatturnedouttobesigniﬁcantlyfaster.Ourtradeoffisthatcase(iii),showninFigure4c),canbeoverlyconservativebyonepixel,whichhasnoeffectoncorrectnessinoursituation.3.3.EvaluatingvisibilityAgivenview-sampleistestedagainstatriangletbycom-putingdistancestotheplanesgivenbyt’ssupportingplaneandthepyramiddeﬁnedbytandthelightsource.Thishastheadvantagethatwecancomputetheplaneequationsonceinthegeometryshaderandthenperformrapidtestsinthefragmentshader.Avoidingbias-Thealgorithmhasaniceproperty:Fortwo-manifold(closed)shadowcasters,eitherthelightback-facingsurfacesorthelightfront-facingsurfacessufﬁcetodeterminetheshadows.Thisfactcanbeutilizedtoavoidincorrectselfshadowingandthecorrespondingproblemofsurfaceacne,withoutusingtheclassicscenedependentsubmittedtoEUROGRAPHICS2008.8
0
0
2

 
c
e
D
8

 

 
-
 

i

 

1
n
o
s
r
e
v
 
,

5
8
2
5
4
3
0
0
-
a
i
r
n

i

4ErikSintorn&ElmarEisemann&UlfAssarsson/SampleBasedVisibilityforSoftShadowsdepthbias[Wil78],triangleID’s[HN85],ordepthvaluesin-sideclosedobjects[Woo92,WE03].Lightback-facingview-samplesdonotneedtobetransferredintotheSMlists,sincetheyalwayswillbeinshadowbytheshading.Thus,se-lectingonlythelightback-facingtrianglesasshadowcast-erseliminatesselfshadowing.Atrianglewillneverbebothashadowcasterandreceiver.Thisalsoavoidsnumericalimprecisionproblemsfromﬂoatingpointtransformationsbetweencoordinatesystems[AL04,Arv07].Theoretically,problemsmightremainwherefront-andback-facestouch,butinpracticewedidnotobservesuchartifacts.Noexam-pleinthepaperusesanydepthbias(e.g.seeleftpartofFigure14thatrendersin66fps).Toavoideventhispoten-tialproblem,anepsilonvaluecouldbeintroducedtooffsetthetriangle’ssupportingplaneslightly.Therearetwopos-sibleoffsets(towardthelightandaway).Duetoourcullingstrategy,selfshadowingdoesnotoccurandbotharevalid.Onefavorslight-,theothershadowleaks.Thelatterarelessdisturbingthanlightleaks(abrightspotinthedarkismoreobviousthanaslightlyextendedshadow).Movingthesup-portingplanetowardsthelightisthusthebetterchoice.Asimilartrickisactuallyoftenusedforstandardshadowmapstoamelioratetheproblemofsurfaceacne.Forclosedshadowcasters,onlythebackfacingtriangleswithrespecttothelightsourcearerenderedintotheshadowmap.However,sincestandardshadowmapsarenotalias-free,artifactswillstillappearnearallsilhouettes,andcarefuladjustmentofabiasandresolutionisrequiredtosuppresstheproblems.3.4.ShortDiscussionofAliasFreeShadowMapsOurmethodshowsmanysimilaritieswiththeworkbyJohn-sonetal.[JLBM05].ThemaindifferencesarethatJohn-sonetal.proposedhardwareextensionstotreatmoregen-eralcasesthanjusthardshadows.Theiralgorithmmakesheavyuseofdynamicallyallocatedlinkedlists.Besidestheadaptedmemorystructures,asupplementaryprocessingunitandwaitingqueueswereproposedtosynchronizework.Werepresentlistsdifferently,makingtheaccessfasterinourcontext(linkedlistiteratorsneedtofollowpointers).Theyareimplementableoncurrenthardwareandcanbeeasilyparallelized(onlythecheapatomicIncr()operationneedssynchronization).Nodynamicreallocationisrequired.Eachsample’sﬁnalpositionisgivenbyanoffsetinaglobalarray,whichisofconstantlength(tightlyboundbytheview-textureresolution).Wecomputeshadowsonlywhereneeded.Conservativerasterizationimprovesuponpreviouswork.Weintroducedawaytoavoiddepthﬁghtingandde-creasethenumberofcastertriangles.Ina5122viewport,ourmethodisusuallyonly≈3timesslowerthanSM(81922).4.SoftShadowsOnlytwostepsofthepreviousSMalgorithmneedtobemodiﬁedforsoftshadowsbyarbitraryvolumetricsources.First,theconservativerasterizationneedstocovertheentireumbraandpenumbraregionofeachshadowcastingtriangle,theso-calledinﬂuenceregion.Second,thefragmentshadertestingforocclusionneedstoconsidermultiplelightsam-ples.Thisissolvedusinga3D-textureasexplainedbelowinSection4.2.Thispipelineissimilarto[ED07].Thema-jordifferencesarethatwetreatarbitraryreceiverswithourlists,computetightinﬂuenceregions,giveanefﬁcientwaytoapplyconservativerasterizationtothem,allowvolumetriclightsources,andweintroduceatemporalanti-aliasing.4.1.Computingtriangle’sinﬂuenceregionApointpcanonlybeshadedbyatrianglet,ifitliesintheunionoft’sprojectionsfromalllightsourcepointsontoaplanepassingthroughp.Thesameholds,foraplanefurtheraway(asseenfromthelight’scenter).Therefore,conserva-tivechoicesforanarbitrarypointofthesceneincludethefarplane(seeFigure5),aﬂoorplane(ifthesceneexhibitsone),oraplaneatadistanceofthefurthestview-sample.AscanbeseeninFigure5(right),whenthedistancebetweenthelightcenterandfarplanegrows,theratiobetweenthesizeoftheinﬂuenceregionandthebaseofthelightfrustumisasymptoticallyboundbytheratiooftheirrespectivean-gles(greenandblue).Thus,thesizeoftheinﬂuenceregionistypicallymoredependantonthetriangle’sdistancetothelightthanthechoiceofthefar-plane.light frustumlight frustumprojectedinfluence regioninfluence regionFar PlaneFar PlaneFigure5:Left:atriangle’sinﬂuenceregionatafarplane.Middle:affectedshadowmappixelswhenrasterizingthein-ﬂuenceregion.Right:theinﬂuenceregionsizeasseenfromthelight,isasymptoticallyboundbytheratiobetweentheblueandgreenangle.Inthecaseofaplanarsource,itisrelativelysimpletocal-culatetheinﬂuenceregionfromashadowcastingtriangle.Letusﬁrstconcentrateonasphericallightsource.Here,theinﬂuenceregiononaplaneismorecomplex.Itisthecon-vexhullofthesource’sprojectionthroughtheverticeswhichformellipsesintheplane.Previousworkapproximatedinﬂuenceregionscoarselywithoneboundingquad[ED07]andwasrestrictedtoplanarsourcesandreceivers.Weprovideasolutionthatallowsar-bitrarilytightboundingregionsforsphericalsourcesandap-plyittoarbitraryreceivers(seeFigure5-left).Foreachtri-anglevertexv,wecomputearegularboundingpolygonofadesireddegree(e.g.ahexagonfor6points)forthelight’ssilhouetteasseenfromv.Thissilhouetteisacirclewhoseradiusandpositioncanbeeasilyinferredandthusthecon-structionofaboundingpolygonPvisdirect.WethenprojectPvthroughvontothefarplane.Thisisdonebycomput-ingtheintersectionofthelinesthroughvandeachvertexsubmittedtoEUROGRAPHICS2008.8
0
0
2

 
c
e
D
8

 

 
-
 

i

 

1
n
o
s
r
e
v
 
,

5
8
2
5
4
3
0
0
-
a
i
r
n

i

ErikSintorn&ElmarEisemann&UlfAssarsson/SampleBasedVisibilityforSoftShadows5ofPvwiththedesiredfarplane.Theseintersectionpointsformboundingpolygonsoftheellipsesandtheirconvexhullboundstheinﬂuenceregion.Theconvexhulliscom-putedwithGraham’sscan[Gra72].ThemethodisO(n)ifallpointsareinclockwiseangularorder.Thisiseasytoassureforthepointsofeachellipse,butthesepointgroupsdonotshareacommoncenter.Fortunately,mergingthemispossi-bleinO(n)time.Thismakesthefullconvexhullcomputa-tionveryrapid.Inpractice,wechosehexagonsandCUDAwasfoundtobeuptotwiceasfastasgeometryshaders.ConservativerasterizationoftheinﬂuenceregionisdonebyadaptingtherulesofFigure4.Weonlyoutputonevertexincase(i)andforcase(ii)iftheanglebetweentheedgesis<90◦theirintersectionpointisusedtooutputonlyonevertex.Toensureconservativecoverageoftheinﬂuenceregionsforanarbitraryvolumetriclightsource,weﬁrstapproximateitbyanellipsoid.Avirtualscalingoftheentiresceneallowsustoreestablishasphericallightsourceforwhichthepreviousalgorithmcanbeused.4.2.SamplingVisibilityofVolumetricSourcesForhardshadows,weusedasinglebittorepresentthevis-ibilityofthepointlightsource.Tocomputesoftshadows,weassociateabitmasktoeachview-sample,whereeachbitcorrespondstothevisibilityofonelightsample.Thismeansthat8MRTsallowustooutput128lightsamplesfor8view-samplesinasinglepass.Multipassrenderingisuseduntilallviewsamplesarecomputed.Tosamplevisibilityintheinﬂuenceregion,weusealightsampledependentlookuptableLU.LUtakesa3D-planeasinputandreturnsabitpatterncorrespondingtothelight-samplesbehindtheplane(Figure6top-left).Combiningthebitmasksoftheplanesdeﬁnedbytheview-sampleandtheedgesofthetriangletviaanANDoperationestablishesthecorrectvisibilitywithrespecttot(Figure6top-right).ThiscanbeseenasanextensionofthemethodbyEisemannandDécoret[ED07]tohandlenon-planarlightsourcesandshadowreceivers.Toaccumulatetheresults,weuse,asbe-foreforthehardshadows,theblendingcapacitiesofgraph-icshardware(namelythebitwiseORoperation).WecanrepresentLUwitha3Dtexturebydescribingtheplanewithtwoanglesandadistance.Tominimizediscretizationerrors,wechooseLU’ssizerela-tivetothenumberofsamples,typically1283per3D-texture.Itleadstogoodshadowqualitywithmoderatememorycost.Ifmoresamplesareneeded,wecanprecomputeadditionalkLU-texturesfork×128differentsamplelocations.Aspointedoutin[ED07],forsymmetricsources,sampletex-turescanbereusedbyrotatingthenormalaroundthesym-metryaxes.Thiscanbedoneonaperpixelbasistoachievejitteringatalmostnocost.Wefurtherproposetemporaljit-teringwheresampleschangeineachtimeframe.Thesolu-tionconvergesrapidlytoahighqualityimageviaaccumu-Rasterized pixel2. combine edges(AND bitmasks)screen samplescreen samplebitmask for one edgebitmasksBlocked samples1. sample lookupfor each edgeFigure6:Visibilityistestedforeachview-sampleineachrasterizedfragment(bottom).Atexturelookupreturnsabit-maskindicatingthelightsamplesbehindtheplanedeﬁnedbyanedgeandtheview-sample(left).TheoccludedlightsamplesareidentiﬁedbyAND:ingthesevalues(right).Thelightsamplescanbearbitrarilylocated.Figure7:Left:Nojittering.Right:jitteringandframeaccu-mulation,afterasecond.Both:128lightsamples.lation,ifthesceneisstaticandthecameradoesnotmove(seeFigure7).Aspointedoutin[SJW07],lowerqualityisacceptableformovingcamerasandforlightdesignersitisusefultohaveafastfeedbackconcerningshadows.4.3.OptimizationsParametrization-Tokeepview-samplelistsshort,exist-ingtechniquestomaximizetheSMresolution(e.g.[MT04])canbeusedtooptimizethesamplerepartition.Agoodsolu-tion,weemployed,istoﬁtthefrustumtoaminimal2D-axisalignedboundingboxoftheprojectedview-samples,andwereadaptthelightfrustumbetweeneachpassofouralgo-rithm.Theparametrizationleadtospeed-upsofaround30%insceneslikeoneinFigure9.Thesamestepalsocomputesthemaximumview-sampledistancetothelightsource.Thisallowsustoﬁtanoptimalfarplane.Thiskeepsinﬂuenceregionssmaller,butitsinﬂuenceonperformanceisweaker.Restrictcomputations-Withthestencilbufferwecanblockallpixelswithemptylists.Further,penumbraecanonlybecastfromsilhouetteedges.Here,silhouettemeansthatthereisapointonthelightforwhichtheedgeisasil-houette.TheirdetectionisdoneinthegeometryshaderorusingCUDAbycomputingtherelativepositionofthelightw.r.t.theplanesdeﬁnedbytheadjacenttriangles[LAA∗05].Theedges’inﬂuenceregionisthenrenderedintothesten-ciloftheSM.Thisblocksunnecessarycomputationsintheumbra/litregion,whereahardshadowfromanysamplepointisenough.Thesamereasoningappliesfortriangles.submittedtoEUROGRAPHICS2008.8
0
0
2

 
c
e
D
8

 

 
-
 

i

 

1
n
o
s
r
e
v
 
,

5
8
2
5
4
3
0
0
-
a
i
r
n

i

6ErikSintorn&ElmarEisemann&UlfAssarsson/SampleBasedVisibilityforSoftShadowsFigure8:Withstandardvertexnormals,lightleaksinback-faces(redline).Webendnormalsforcoherentshading.Ifmodelsarewatertight,trianglescanbeeliminatedbasedonconservativeback-faceculling[ED07],alsowecancutofftheinﬂuenceregionbasedonthetriangle’ssupportingplane[LLA06],thisintegrateswellinourconvexhullcom-putation.Bothmeasuresmadethesoftshadowpasswinupto50%.Anotherpossibilitywouldbetoapplyaperceptualmeasure,e.g.basedonthefrequencyofstandardlightingandtexturingtochooseonlyaview-samplesubset.Areconstruc-tionstepyieldstheﬁnalimage.Aﬁrststepinthecontextofshadowswaspresentedin[GBP07].Wedidnotrelyonthisforourtimingstoshowtheactualcost.Shading-ThestandardGouraud/Phongshadingmodelsusepervertexnormalsforasmoothinterpolant.Thismightleadtolightbleedingintoback-facingtriangles(seeﬁg-ure8).Itintroducesartifactsatlightsilhouetteedgesbe-causeaccurateshadowsleadtoself-shadowingandcreateastrongdiscontinuity.Thisisparticularlydisturbingforhardshadows.Toavoidthisbehavior,webendvertexnormalswithrespecttotheadjacentfaces.Thegeometryshaderin-put(triangleswithadjacency)doesnotprovidealltrianglesincidenttoavertex.Nevertheless,passingfacenormalsinatextureandadjacentfaceindicesastexturecoordinatesal-lowsarapidGPUevaluation.Incasethenumberofneigh-borsissmall,normalscanbesentdirectlythroughtexturecoordinates.Interpolatingtheminimumilluminationbasedonadjacentfacenormalsdeliversasmoothresultthaten-suresblacknessofalllightback-facingtriangles.Formally,wecomputeateachvertex:lbend=minF∈adj(v)dot(l,nF)wherenFisthenormaloffaceF,lthelightvector,andadj(v)theadjacentfacestov.Perfragment,wecansecurelyandcontinuouslyblendbacktoPhongilluminationlf,us-ing:α:=min(1,max(clbend,0)),αlf+(1−α)lbend.c:=3workswell.Softshadowsaresmootherandthusbentnor-malswithrespecttothesource’scenterareoftensufﬁcient.Thedeﬁnitioncouldbeextendedtotheminimumwithre-specttotheentiresourceoraboundingvolume(e.g.acube).5.ResultsAllmeasurementswereperformedusing5122resolutionandaGeforce8800GTS-512.Fivetestsceneswhereused.Afairyof734triangles,columnsof840triangles,ahair-   10.80.60.40.2   0   0128256512viewport resolution% of occupied listsin a 512 x 512 SMAv.occup.list sizeMaxlist sizeview-portres.512^2384^2256^2128^23.32.41.71.3161884013List statisticsFigure9:Sponza(73ktris),thisview:20kshadowcastingtris,256lightsamples.Inlay:SMlistlengthinformation.Figure10:Shadowquality:128samples/512samplesballof44ktris,atorus-knotofvaryingtessellationdegrees,theSponzaAtriumof73ktriangles,andveryhighpolygonsceneslikearingingrassof379ktrisandothersshowninFigure15.Figure10stressesthesamplingqualityforalargepenumbra.Thevisualdifferencebetween512and1024sam-pleswasnegligibleinthiscase.Figure12showsalinearde-pendencewhenvaryingthelightradius.Forthecaseofin-creasingsamples(Figure13)therenderingcostroughlyonlydoublesfrom128to1024.Ourmethodisaboutanorderofmagnitudefasterthanusingacorrespondingamountofshadowmaps,whichwouldbeanalternativeforproducingsamplebasedsoftshadowsonarbitraryreceivers,buttheyexhibitaliasingartifacts.Itworksrobustlyevenforcompli-catedsceneslikethehairball(Figure14).Figure11uses128lightsamplesandvariesthetessellationdegree.Inthiscase,thealgorithmbehavesmostlylinearinthenumberoftriangles.Neverthelessouroptimizations(sec-tion4)totransferonlyvisibleview-samplesandeliminateemptylists(ﬁgure9showstypicalstatistics),aswellastherestrictiontopenumbraregionsleadtoimportantgains.TherightmostimageinFigure15showsascenefrom[LAA∗05].ThecomputationtimeusingLaineetal.’salgorithmreported75secondsfora5122imageofthisscene.Incontrast,weachieveaframe-rateofalmostconstant0.65Hzindepen-dentlyoftheviewpoint,whichcorrespondstoaspeed-upof48.75.Figure9showstheSponzaAtrium,runningin2.6fpswith256lightsamples,comparedto9secondsforOverbecketal.[ORM07].Wethusprovidea23.4timesspeedup.In-creasingthenumberofsamplesinthisscenedidnotleadtonoticeablequalityimprovements,butingeneral,Overbecketal.’ssolutionisexact,notsampledlikeours.submittedtoEUROGRAPHICS2008.8
0
0
2

 
c
e
D
8

 

 
-
 

i

 

1
n
o
s
r
e
v
 
,

5
8
2
5
4
3
0
0
-
a
i
r
n

i

ErikSintorn&ElmarEisemann&UlfAssarsson/SampleBasedVisibilityforSoftShadows71,200 triangles21 fps12,000 triangles,8 fps24,000 triangles, 4 fpsFigure11:Varyingnumberoftriangles.r = 415 fpsr = 167.1 fpsr = 812 fpsFigure12:Varyinglightradiusr.256samples.6Ktris.6.ConclusionandFutureworkWepresentedanaccuratesolutiontothegeneralsoftshadowsamplingproblem.Oursoft-shadowalgorithmoutperformsSoftShadowVolumesforraytracingby1-2ordersofmagni-tude,andshadowrayswith2-3ordersandhassimilarimagequality.Ouraliasfreeshadowmaps,havecomparableper-formanceto[LSO07],buttheimplementationeffortofoursolutionismuchlowerandhasvirtuallyinﬁniteresolution.Approximatetransparencyispossiblebymultiplyingthetransparencyvaluesofshadowcastingtrianglesandweight-ingbythepercentageofcoverage.Forcorrecttransparency,eachsamplewouldneedtostoreoneRGBA-valueperlightsample,whichrequiresmorebitsthancurrentlyavailable.Weconsideredusingsilhouetteedgestointegratevisibilityforeachview-sample[LAA∗05],butthencounters(insteadofbits)areneededforeachlightsample,reducingtheirnum-ber.Potentialproblemsareinaccuratedepthcomplexityand1.81.61.41.2   10.80.60.40.2   0   01282565121024samplesUsing a shadow mapper sampleOursecsFigure13:Performancecomparisonvs.shadowmaps.Figure14:Hardandsoftshadows(44ktris).thelimitedcounters,buttransparencycanbehandledgrace-fully.Concurrently,suchamethodwaspublished[FBP08].References[AAM03]ASSARSSONU.,AKENINE-MÖLLERT.:Ageometry-basedsoftshadowvolumealgorithmusinggraphicshardware.ACMTrans.Graph.22,3(2003).[AHL∗06]ATTYL.,HOLZSCHUCHN.,LAPIERREM.,HASENFRATZJ.-M.,HANSENC.,SILLIONF.:Softshadowmaps:Efﬁcientsamplingoflightsourcevisibil-ity.ComputerGraphicsForum25,4(2006).[AL04]AILAT.,LAINES.:Alias-freeshadowmaps.InProceedingsofEurographicsSymposiumonRendering(2004),EurographicsAssociation.[AMB∗07]ANNENT.,MERTENST.,BEKAERTP.,SEI-DELH.-P.,KAUTZJ.:Convolutionshadowmaps.InProceedingsofEurographicsSymposiumonRendering(2007),vol.18,Eurographics.[ARHM00]AGRAWALAM.,RAMAMOORTHIR.,HEIRICHA.,MOLLL.:Efﬁcientimage-basedmeth-odsforrenderingsoftshadows.InProceedingsofSIGGRAPH(2000),AnnualConferenceSeries,ACMSIGGRAPH.[Arv07]ARVOJ.:Alias-freeshadowmapsusinggraphicshardware.journalofgraphicstools12,1(2007).[BWG03]BALAK.,WALTERB.,GREENBERGD.P.:Combiningedgesandpointsforinteractivehigh-qualityrendering.ACMTransactionsonGraphics22,3(2003).[Cro77]CROWF.C.:Shadowalgorithmsforcomputergraphics.ComputerGraphics(SIGGRAPH1977)11,3(1977).[ED06]EISEMANNE.,DÉCORETX.:Plausibleimagebasedsoftshadowsusingocclusiontextures.InProceed-ingsofSIBGRAPI(2006),IEEEComputerSociety.[ED07]EISEMANNE.,DÉCORETX.:Visibilitysamplingongpuandapplications.ComputerGraphicsForum(Pro-ceedingsofEurographics)26,3(2007).[FBP06]FORESTV.,BARTHEL.,PAULINM.:Realisticsoftshadowsbypenumbra-wedgesblending.InGH’06:Proceedingsofthe21stACMSIGGRAPH/EurographicssymposiumonGraphicshardware(2006),ACM.[FBP08]FORESTV.,BARTHEL.,PAULINM.:Accu-rateShadowsbyDepthComplexitySampling.ComputerGraphicsForum(ProceedingsofEurographics)(2008).[GBP06]GUENNEBAUDG.,BARTHEL.,PAULINM.:Real-timesoftshadowmappingbybackprojection.InEurographicsSymposiumonRendering,Nicosia,Cyprus,26/06/06-28/06/06(2006),Eurographics.[GBP07]GUENNEBAUDG.,BARTHEL.,PAULINM.:High-QualityAdaptiveSoftShadowMapping.ComputerGraphicsForum,Eurographics2007proceedings(2007).submittedtoEUROGRAPHICS2008.8
0
0
2

 
c
e
D
8

 

 
-
 

i

 

1
n
o
s
r
e
v
 
,

5
8
2
5
4
3
0
0
-
a
i
r
n

i

8ErikSintorn&ElmarEisemann&UlfAssarsson/SampleBasedVisibilityforSoftShadowsFigure15:Lefttoright:90ktriangles(7fps),zoomed(4.5fps),70ktriangles(4.8fps),ringscene:379ktriangles(0.65fps).[Gra72]GRAHAMR.L.:Anefﬁcientalgorithmfordeter-miningtheconvexhullofaﬁniteplanarset.InformationProcessingLetters1(1972).[HAMO05]HASSELGRENJ.,AKENINE-MÖLLERT.,OHLSSONL.:Conservativerasterizationonthegpu.InGPUGems2(2005),Adison-Wesley.[HH97]HECKBERTP.S.,HERFM.:SimulatingSoftShadowswithGraphicsHardware.Tech.Rep.CMU-CS-97-104,CarnegieMellonUniversity,1997.[HLHS03]HASENFRATZJ.-M.,LAPIERREM.,HOLZSCHUCHN.,SILLIONF.:Asurveyofreal-timesoftshadowsalgorithms.ComputerGraphicsForum22,4(2003).State-of-the-ArtReviews.[HN85]HOURCADEJ.-C.,NICOLASA.:Algorithmsforantialiasedcastshadows.Computer&Graphics(1985).[HSO07]HARRISM.,SENGUPTAS.,OWENSJ.D.:Par-allelpreﬁxsum(scan)withCUDA.InGPUGems3.Addison-Wesley,2007,ch.39.[JLBM05]JOHNSONG.S.,LEEJ.,BURNSC.A.,MARKW.R.:Theirregularz-buffer:Hardwareaccel-erationforirregulardatastructures.ACMTrans.Graph.24,4(2005).[KLA04]KAUTZJ.,LEHTINENJ.,AILAT.:Hemispher-icalrasterizationforself-shadowingofdynamicobjects.InProceedingsofEurographicsSymposiumonRender-ing(2004),EurographicsAssociation.[LAA∗05]LAINES.,AILAT.,ASSARSSONU.,LEHTI-NENJ.,AKENINE-MÖLLERT.:Softshadowvolumesforraytracing.ACMTransactionsonGraphics24,3(2005).[LLA06]LEHTINENJ.,LAINES.,AILAT.:Animprovedphysically-basedsoftshadowvolumealgorithm.Com-puterGraphicsForum25,3(2006).[LSO07]LEFOHNA.E.,SENGUPTAS.,OWENSJ.D.:Resolutionmatchedshadowmaps.ACMTransactionson26,4(2007).[MB07]MYERSK.,BAVOILL.:Stencilrouteda-buffer.InSIGGRAPH’07:ACMSIGGRAPH2007sketches(2007),ACM.[MT04]MARTINT.,TANT.-S.:Anti-aliasingandconti-nuitywithtrapezoidalshadowmaps.InProceedingsofthe2ndEGSymposiumonRendering(2004),SpringerComputerScience,EurographicsAssociation.[MW07]MOQ.,WYMANC.:Interactivebackprojectedsoftshadowswithanocclusioncamerashadowmap.InSIGGRAPHPosters(2007),ACM.[ORM07]OVERBECKR.,RAMAMOORTHIR.,MARKW.R.:AReal-timeBeamTracerwithApplicationtoExactSoftShadows.InRenderingTechniques(2007),EurographicsAssociation.[PCdON04]PAGOTC.A.,COMBAJ.L.D.,DEOLIVEIRANETOM.M.:Multiple-depthshadowmaps.InProceedingsofSIBGRAPI(2004),IEEEComputerSociety.[SJW07]SCHERZERD.,JESCHKES.,WIMMERM.:Pixel-correctshadowmapswithtemporalreprojectionandshadowtestconﬁdence.InRenderingTechniques2007(ProceedingsEurographicsSymposiumonRender-ing)(2007),EurographicsAssociation.[SS07]SCHWARZM.,STAMMINGERM.:Bitmasksoftshadows.ComputerGraphicsForum26,3(2007).[WE03]WEISKOPFD.,ERTLT.:ShadowMappingBasedonDualDepthLayers.InProceedingsofEuro-graphics’03ShortPapers(2003).[Wil78]WILLIAMSL.:Castingcurvedshadowsoncurvedsurfaces.ComputerGraphics(SIGGRAPH1978)12,3(1978).[Woo92]WOOA.:Theshadowdepthmaprevisited.InGraphicsGemsIII.AcademicPressProfessional,Inc.,1992.[WPF90]WOOA.,POULINP.,FOURNIERA.:Asurveyofshadowalgorithms.IEEEComputerGraphicsandAp-plications10,6(1990).[WSP04]WIMMERM.,SCHERZERD.,PURGATHOFERW.:Lightspaceperspectiveshadowmaps.InProceedingsofthe2ndEGSymposiumonRendering(2004),SpringerComputerScience,EurographicsAssociation.[XTP07]XIEF.,TABELLIONE.,PEARCEA.:SoftShadowsbyRayTracingMultilayerTransparentShadowMaps.InRenderingTechniques(2007),EurographicsAssociation.submittedtoEUROGRAPHICS2008.